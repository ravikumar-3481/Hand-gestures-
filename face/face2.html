<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Face Matcher</title>
    <!-- FaceAPI.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .video-wrapper {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
        }
        video {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1); /* Mirror effect */
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            transform: scaleX(-1); /* Match mirror effect */
        }
        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: scan 2s linear infinite;
            z-index: 5;
            opacity: 0.5;
            display: none; /* Show only when active */
        }
        @keyframes scan {
            0% { top: 0%; }
            100% { top: 100%; }
        }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <header class="text-center mb-6">
        <h1 class="text-3xl font-bold text-blue-500">Live Face Matcher</h1>
        <p class="text-slate-400 text-sm">Upload Photo vs Real-time Camera</p>
    </header>

    <!-- Main Grid -->
    <div class="w-full max-w-5xl grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- Sidebar: Upload Section -->
        <div class="md:col-span-1 flex flex-col gap-4">
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg">
                <h2 class="text-lg font-semibold text-yellow-400 mb-2">Step 1: Reference Photo</h2>
                <div class="relative w-full h-48 bg-slate-800 rounded-lg overflow-hidden border-2 border-dashed border-slate-600 flex items-center justify-center group">
                    <img id="ref-preview" class="absolute inset-0 w-full h-full object-cover hidden" alt="Reference">
                    <div class="text-center p-4 group-hover:opacity-75 transition-opacity" id="upload-placeholder">
                        <svg class="w-8 h-8 mx-auto text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span class="text-xs text-slate-400">Tap to Upload</span>
                    </div>
                    <input type="file" id="image-upload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                </div>
                <p id="ref-status" class="text-xs text-slate-500 mt-2 text-center">No image selected</p>
            </div>

            <!-- Stats Panel -->
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800 shadow-lg flex flex-col justify-center items-center">
                <h2 class="text-sm font-semibold text-slate-400 mb-1">Match Score</h2>
                <div id="score-display" class="text-5xl font-black text-slate-700">0%</div>
                <div id="match-verdict" class="mt-2 px-3 py-1 rounded-full text-xs font-bold bg-slate-800 text-slate-500">WAITING...</div>
            </div>
        </div>

        <!-- Main: Camera Feed -->
        <div class="md:col-span-2">
            <div class="bg-slate-900 p-2 rounded-xl border border-slate-800 shadow-2xl relative">
                <!-- Loader -->
                <div id="loader" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 bg-opacity-95 rounded-xl">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-500 mb-3"></div>
                    <p class="text-blue-400 font-mono text-sm animate-pulse">Loading AI Models...</p>
                </div>

                <div class="video-wrapper">
                    <div class="scan-line" id="scanner"></div>
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="overlay"></canvas>
                </div>
                
                <div class="p-3 bg-black mt-2 rounded border border-slate-800 font-mono text-xs text-green-400 h-24 overflow-y-auto" id="logs">
                    > System initializing...
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const uploadInput = document.getElementById('image-upload');
        const refPreview = document.getElementById('ref-preview');
        const refStatus = document.getElementById('ref-status');
        const scoreDisplay = document.getElementById('score-display');
        const verdictBadge = document.getElementById('match-verdict');
        const loader = document.getElementById('loader');
        const scanner = document.getElementById('scanner');
        const logBox = document.getElementById('logs');
        
        let referenceDescriptor = null;
        let isModelLoaded = false;
        let detectionInterval;

        function log(msg) {
            const line = document.createElement('div');
            line.textContent = `> ${msg}`;
            logBox.appendChild(line);
            logBox.scrollTop = logBox.scrollHeight;
        }

        // 1. Load FaceAPI Models
        async function loadModels() {
            try {
                const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL), // Heavy but accurate
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                isModelLoaded = true;
                loader.classList.add('hidden');
                log("Models Loaded. Please upload a photo.");
                startVideo();
            } catch (err) {
                log("Error loading models: " + err);
            }
        }

        // 2. Start Webcam
        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
            } catch (err) {
                log("Camera Error: " + err);
            }
        }

        // 3. Handle Image Upload & Extract Descriptor
        uploadInput.addEventListener('change', async (e) => {
            if (!isModelLoaded) return alert("Please wait for models to load.");
            const file = e.target.files[0];
            if (!file) return;

            // Update UI
            const imgUrl = URL.createObjectURL(file);
            refPreview.src = imgUrl;
            refPreview.classList.remove('hidden');
            document.getElementById('upload-placeholder').classList.add('hidden');
            refStatus.innerText = "Analyzing face...";
            refStatus.className = "text-xs text-yellow-400 mt-2 text-center animate-pulse";

            // Process Image
            const img = await faceapi.fetchImage(imgUrl);
            const detections = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();

            if (detections) {
                referenceDescriptor = detections.descriptor;
                refStatus.innerText = "Target Face Locked ✅";
                refStatus.className = "text-xs text-green-400 mt-2 text-center font-bold";
                log("Reference face processed successfully.");
                scanner.style.display = 'block'; // Start scanner effect
            } else {
                referenceDescriptor = null;
                refStatus.innerText = "No face found in photo ❌";
                refStatus.className = "text-xs text-red-400 mt-2 text-center font-bold";
                log("Failed to detect face in uploaded image.");
            }
        });

        // 4. Real-time Detection Loop
        video.addEventListener('play', () => {
            const displaySize = { width: video.width, height: video.height };
            
            // Adjust canvas to match video
            setInterval(async () => {
                if (!isModelLoaded) return;
                
                // Ensure canvas size matches video
                if (canvas.width !== video.videoWidth) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    faceapi.matchDimensions(canvas, { width: video.videoWidth, height: video.videoHeight });
                }

                // Detect face in webcam
                const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();

                // Clear previous drawings
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (detection) {
                    const resizedDetections = faceapi.resizeResults(detection, { width: video.videoWidth, height: video.videoHeight });
                    
                    // Logic: Compare with Reference
                    if (referenceDescriptor) {
                        const distance = faceapi.euclideanDistance(referenceDescriptor, detection.descriptor);
                        
                        // Convert distance to score (Inverse logic: lower distance = higher match)
                        // Threshold is usually 0.6. 
                        // If distance is 0.4, match is good.
                        // Formula: Let's map 0.0-0.6 range to 100%-40% roughly
                        let score = Math.max(0, (1 - distance) * 100);
                        
                        updateUI(score);
                        drawBox(resizedDetections.detection.box, score);
                    } else {
                        // Just draw the face box if no reference
                        const box = resizedDetections.detection.box;
                        new faceapi.draw.DrawBox(box, { label: "Face Detected", boxColor: "blue" }).draw(canvas);
                        verdictBadge.innerText = "UPLOAD PHOTO";
                        verdictBadge.className = "mt-2 px-3 py-1 rounded-full text-xs font-bold bg-slate-800 text-slate-500";
                    }
                } else {
                    scoreDisplay.innerText = "0%";
                    scoreDisplay.className = "text-5xl font-black text-slate-700";
                }
            }, 200); // Check every 200ms
        });

        function updateUI(score) {
            const scoreFixed = score.toFixed(0);
            scoreDisplay.innerText = `${scoreFixed}%`;

            if (score > 60) {
                scoreDisplay.className = "text-5xl font-black text-green-500";
                verdictBadge.innerText = "MATCH CONFIRMED";
                verdictBadge.className = "mt-2 px-3 py-1 rounded-full text-xs font-bold bg-green-900 text-green-300 border border-green-500";
                log(`Match Found: ${scoreFixed}%`);
            } else if (score > 40) {
                scoreDisplay.className = "text-5xl font-black text-yellow-500";
                verdictBadge.innerText = "POSSIBLE MATCH";
                verdictBadge.className = "mt-2 px-3 py-1 rounded-full text-xs font-bold bg-yellow-900 text-yellow-300 border border-yellow-500";
            } else {
                scoreDisplay.className = "text-5xl font-black text-red-500";
                verdictBadge.innerText = "NO MATCH";
                verdictBadge.className = "mt-2 px-3 py-1 rounded-full text-xs font-bold bg-red-900 text-red-300 border border-red-500";
            }
        }

        function drawBox(box, score) {
            const color = score > 60 ? '#22c55e' : '#ef4444'; // Green or Red
            const label = score > 60 ? `Match: ${score.toFixed(0)}%` : `Mismatch`;
            
            const drawBox = new faceapi.draw.DrawBox(box, { 
                label: label, 
                boxColor: color,
                lineWidth: 3
            });
            drawBox.draw(canvas);
        }

        loadModels();
    </script>
</body>
</html>


